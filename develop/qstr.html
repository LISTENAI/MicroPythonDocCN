
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>MicroPython string interning &#8212; MicroPython 1.18 documentation</title>
    <link rel="stylesheet" href="../_static/material.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/customstyle.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Maps and Dictionaries" href="maps.html" />
    <link rel="prev" title="Optimizations" href="optimizations.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=blue-grey data-md-color-accent=blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#develop/qstr" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../index.html" title="MicroPython 1.18 documentation"
           class="md-header-nav__button md-logo">
          
            &nbsp;
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">MicroPython 1.18 documentation</span>
          <span class="md-header-nav__topic"> MicroPython string interning </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
      
  
  <script src="../_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../"versions.json"",
        target_loc = "../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="../index.html" class="md-tabs__link">MicroPython 1.18 documentation</a></li>
          <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">MicroPython Internals</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../index.html" title="MicroPython 1.18 documentation" class="md-nav__button md-logo">
      
        <img src="../_static/" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../index.html"
       title="MicroPython 1.18 documentation">MicroPython 1.18 documentation</a>
  </label>
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
    
      <a href="../library/index.html" class="md-nav__link">MicroPython libraries</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../reference/index.html" class="md-nav__link">MicroPython language and implementation</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../genrst/index.html" class="md-nav__link">MicroPython differences from CPython</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="index.html" class="md-nav__link">MicroPython Internals</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../license.html" class="md-nav__link">MicroPython license information</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../pyboard/quickref.html" class="md-nav__link">Quick reference for the pyboard</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../esp8266/quickref.html" class="md-nav__link">Quick reference for the ESP8266</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../esp32/quickref.html" class="md-nav__link">Quick reference for the ESP32</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../rp2/quickref.html" class="md-nav__link">Quick reference for the RP2</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../wipy/quickref.html" class="md-nav__link">Quick reference for the WiPy</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../unix/quickref.html" class="md-nav__link">Quick reference for the UNIX and Windows ports</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../zephyr/quickref.html" class="md-nav__link">Quick reference for the Zephyr port</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#develop-qstr--page-root" class="md-nav__link">MicroPython string interning</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#compile-time-qstr-generation" class="md-nav__link">Compile-time QSTR generation</a>
        </li>
        <li class="md-nav__item"><a href="#run-time-qstr-generation" class="md-nav__link">Run-time QSTR generation</a>
        </li></ul>
            </nav>
        </li>
  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  
<span id="qstr"></span><h1 id="develop-qstr--page-root">MicroPython string interning<a class="headerlink" href="#develop-qstr--page-root" title="Permalink to this headline">¶</a></h1>
<p>MicroPython uses <a class="reference external" href="https://en.wikipedia.org/wiki/String_interning">string interning</a> to save both RAM and ROM.  This avoids
having to store duplicate copies of the same string.  Primarily, this applies to
identifiers in your code, as something like a function or variable name is very
likely to appear in multiple places in the code.  In MicroPython an interned
string is called a QSTR (uniQue STRing).</p>
<p>A QSTR value (with type <code class="docutils literal notranslate"><span class="pre">qstr</span></code>) is a index into a linked list of QSTR pools.
QSTRs store their length and a hash of their contents for fast comparison during
the de-duplication process.  All bytecode operations that work with strings use
a QSTR argument.</p>

<h2 id="compile-time-qstr-generation">Compile-time QSTR generation<a class="headerlink" href="#compile-time-qstr-generation" title="Permalink to this headline">¶</a></h2>
<p>In the MicroPython C code, any strings that should be interned in the final
firmware are written as <code class="docutils literal notranslate"><span class="pre">MP_QSTR_Foo</span></code>.  At compile time this will evaluate to
a <code class="docutils literal notranslate"><span class="pre">qstr</span></code> value that points to the index of <code class="docutils literal notranslate"><span class="pre">"Foo"</span></code> in the QSTR pool.</p>
<p>A multi-step process in the <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> makes this work.  In summary this
process has three parts:</p>
<ol class="arabic simple">
<li><p>Find all <code class="docutils literal notranslate"><span class="pre">MP_QSTR_Foo</span></code> tokens in the code.</p></li>
<li><p>Generate a static QSTR pool containing all the string data (including lengths
and hashes).</p></li>
<li><p>Replace all <code class="docutils literal notranslate"><span class="pre">MP_QSTR_Foo</span></code> (via the preprocessor) with their corresponding
index.</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">MP_QSTR_Foo</span></code> tokens are searched for in two sources:</p>
<ol class="arabic simple">
<li><p>All files referenced in <code class="docutils literal notranslate"><span class="pre">$(SRC_QSTR)</span></code>.  This is all C code (i.e. <code class="docutils literal notranslate"><span class="pre">py</span></code>,
<code class="docutils literal notranslate"><span class="pre">extmod</span></code>, <code class="docutils literal notranslate"><span class="pre">ports/stm32</span></code>) but not including third-party code such as
<code class="docutils literal notranslate"><span class="pre">lib</span></code>.</p></li>
<li><p>Additional <code class="docutils literal notranslate"><span class="pre">$(QSTR_GLOBAL_DEPENDENCIES)</span></code> (which includes <code class="docutils literal notranslate"><span class="pre">mpconfig*.h</span></code>).</p></li>
</ol>
<p><em>Note:</em> <code class="docutils literal notranslate"><span class="pre">frozen_mpy.c</span></code> (generated by mpy-tool.py) has its own QSTR generation
and pool.</p>
<p>Some additional strings that can’t be expressed using the <code class="docutils literal notranslate"><span class="pre">MP_QSTR_Foo</span></code> syntax
(e.g. they contain non-alphanumeric characters) are explicitly provided in
<code class="docutils literal notranslate"><span class="pre">qstrdefs.h</span></code> and <code class="docutils literal notranslate"><span class="pre">qstrdefsport.h</span></code> via the <code class="docutils literal notranslate"><span class="pre">$(QSTR_DEFS)</span></code> variable.</p>
<p>Processing happens in the following stages:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">qstr.i.last</span></code> is the concatenation of putting every single input file
through the C pre-processor.  This means that any conditionally disabled code
will be removed, and macros expanded.  This means we don’t add strings to the
pool that won’t be used in the final firmware.  Because at this stage (thanks
to the <code class="docutils literal notranslate"><span class="pre">NO_QSTR</span></code> macro added by <code class="docutils literal notranslate"><span class="pre">QSTR_GEN_CFLAGS</span></code>) there is no
definition for <code class="docutils literal notranslate"><span class="pre">MP_QSTR_Foo</span></code> it passes through this stage unaffected.  This
file also includes comments from the preprocessor that include line number
information.  Note that this step only uses files that have changed, which
means that <code class="docutils literal notranslate"><span class="pre">qstr.i.last</span></code> will only contain data from files that have
changed since the last compile.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">qstr.split</span></code> is an empty file created after running <code class="docutils literal notranslate"><span class="pre">makeqstrdefs.py</span> <span class="pre">split</span></code>
on qstr.i.last. It’s just used as a dependency to indicate that the step ran.
This script outputs one file per input C file,  <code class="docutils literal notranslate"><span class="pre">genhdr/qstr/...file.c.qstr</span></code>,
which contains only the matched QSTRs. Each QSTR is printed as <code class="docutils literal notranslate"><span class="pre">Q(Foo)</span></code>.
This step is necessary to combine the existing files with the new data
generated from the incremental update in <code class="docutils literal notranslate"><span class="pre">qstr.i.last</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">qstrdefs.collected.h</span></code> is the output of concatenating <code class="docutils literal notranslate"><span class="pre">genhdr/qstr/*</span></code>
using <code class="docutils literal notranslate"><span class="pre">makeqstrdefs.py</span> <span class="pre">cat</span></code>.  This is now the full set of <code class="docutils literal notranslate"><span class="pre">MP_QSTR_Foo</span></code>’s
found in the code, now formatted as <code class="docutils literal notranslate"><span class="pre">Q(Foo)</span></code>, one-per-line, with duplicates.
This file is only updated if the set of qstrs has changed.  A hash of the QSTR
data is written to another file (<code class="docutils literal notranslate"><span class="pre">qstrdefs.collected.h.hash</span></code>) which allows
it to track changes across builds.</p></li>
<li><p>Generate an enumeration, each entry of which maps a <code class="docutils literal notranslate"><span class="pre">MP_QSTR_Foo</span></code> to it’s corresponding index.
It concatenates <code class="docutils literal notranslate"><span class="pre">qstrdefs.collected.h</span></code> with <code class="docutils literal notranslate"><span class="pre">qstrdefs*.h</span></code>, then it transforms
each line from <code class="docutils literal notranslate"><span class="pre">Q(Foo)</span></code> to <code class="docutils literal notranslate"><span class="pre">"Q(Foo)"</span></code> so they pass through the preprocessor
unchanged.  Then the preprocessor is used to deal with any conditional
compilation in <code class="docutils literal notranslate"><span class="pre">qstrdefs*.h</span></code>.  Then the transformation is undone back to
<code class="docutils literal notranslate"><span class="pre">Q(Foo)</span></code>, and saved as <code class="docutils literal notranslate"><span class="pre">qstrdefs.preprocessed.h</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">qstrdefs.generated.h</span></code> is the output of <code class="docutils literal notranslate"><span class="pre">makeqstrdata.py</span></code>.  For each
<code class="docutils literal notranslate"><span class="pre">Q(Foo)</span></code> in qstrdefs.preprocessed.h (plus some extra hard-coded ones), it outputs
<code class="docutils literal notranslate"><span class="pre">QDEF(MP_QSTR_Foo,</span> <span class="pre">(const</span> <span class="pre">byte*)"hash"</span> <span class="pre">"Foo")</span></code>.</p></li>
</ol>
<p>Then in the main compile, two things happen with <code class="docutils literal notranslate"><span class="pre">qstrdefs.generated.h</span></code>:</p>
<ol class="arabic simple">
<li><p>In qstr.h, each QDEF becomes an entry in an enum, which makes <code class="docutils literal notranslate"><span class="pre">MP_QSTR_Foo</span></code>
available to code and equal to the index of that string in the QSTR table.</p></li>
<li><p>In qstr.c, the actual QSTR data table is generated as elements of the
<code class="docutils literal notranslate"><span class="pre">mp_qstr_const_pool-&gt;qstrs</span></code>.</p></li>
</ol>


<h2 id="run-time-qstr-generation">Run-time QSTR generation<a class="headerlink" href="#run-time-qstr-generation" title="Permalink to this headline">¶</a></h2>
<p>Additional QSTR pools can be created at runtime so that strings can be added to
them. For example, the code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">foo</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
<p>Will need to create a QSTR for the value of <code class="docutils literal notranslate"><span class="pre">x</span></code> so it can be used by the
“load attr” bytecode.</p>
<p>Also, when compiling Python code, identifiers and literals need to have QSTRs
created.  Note: only literals shorter than 10 characters become QSTRs.  This is
because a regular string on the heap always takes up a minimum of 16 bytes (one
GC block), whereas QSTRs allow them to be packed more efficiently into the pool.</p>
<p>QSTR pools (and the underlying “chunks” that store the string data) are allocated
on-demand on the heap with a minimum size.</p>




          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="optimizations.html" title="Optimizations"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> Optimizations </span>
              </div>
            </a>
          
          
            <a href="maps.html" title="Maps and Dictionaries"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> Next </span> Maps and Dictionaries </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright - The MicroPython Documentation is Copyright © 2014-2022, Damien P. George, Paul Sokolovsky, and contributors.
              
          </div>
            Last updated on
              10 Feb 2022.
            <br/>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 2.4.4.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>