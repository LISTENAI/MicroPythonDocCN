
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>MicroPython external C modules &#8212; MicroPython 1.18 文档</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/material.css" />
    <link rel="stylesheet" href="../_static/customstyle.css" type="text/css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/translations.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="Native machine code in .mpy files" href="natmod.html" />
    <link rel="prev" title="Extending MicroPython in C" href="extendingmicropython.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=blue data-md-color-accent=light-blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#develop/cmodules" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../index.html" title="MicroPython 1.18 文档"
           class="md-header-nav__button md-logo">
          
            &nbsp;
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">MicroPython 1.18 文档</span>
          <span class="md-header-nav__topic"> MicroPython external C modules </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
      
  
  <script src="../_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../"versions.json"",
        target_loc = "../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="../index.html" class="md-tabs__link">MicroPython 1.18 文档</a></li>
          <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">MicroPython Internals</a></li>
          <li class="md-tabs__item"><a href="extendingmicropython.html" class="md-tabs__link">Extending MicroPython in C</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../index.html" title="MicroPython 1.18 文档" class="md-nav__button md-logo">
      
        <img src="../_static/" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../index.html"
       title="MicroPython 1.18 文档">MicroPython 1.18 文档</a>
  </label>
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
    
      <a href="../library/index.html" class="md-nav__link">MicroPython libraries</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../reference/index.html" class="md-nav__link">MicroPython language and implementation</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../genrst/index.html" class="md-nav__link">MicroPython differences from CPython</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="index.html" class="md-nav__link">MicroPython Internals</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="gettingstarted.html" class="md-nav__link">Getting Started</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="writingtests.html" class="md-nav__link">Writing tests</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="compiler.html" class="md-nav__link">The Compiler</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="memorymgt.html" class="md-nav__link">Memory Management</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="library.html" class="md-nav__link">Implementing a Module</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="optimizations.html" class="md-nav__link">Optimizations</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="qstr.html" class="md-nav__link">MicroPython string interning</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="maps.html" class="md-nav__link">Maps and Dictionaries</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="publiccapi.html" class="md-nav__link">The public C API</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="extendingmicropython.html" class="md-nav__link">Extending MicroPython in C</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    <label class="md-nav__link md-nav__link--active" for="__toc"> MicroPython external C modules </label>
    
      <a href="#" class="md-nav__link md-nav__link--active">MicroPython external C modules</a>
      
        
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#develop-cmodules--page-root" class="md-nav__link">MicroPython external C modules</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#structure-of-an-external-c-module" class="md-nav__link">Structure of an external C module</a>
        </li>
        <li class="md-nav__item"><a href="#basic-example" class="md-nav__link">Basic example</a>
        </li>
        <li class="md-nav__item"><a href="#compiling-the-cmodule-into-micropython" class="md-nav__link">Compiling the cmodule into MicroPython</a>
        </li>
        <li class="md-nav__item"><a href="#module-usage-in-micropython" class="md-nav__link">Module usage in MicroPython</a>
        </li></ul>
            </nav>
        </li>
  </ul>
</nav>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#structure-of-an-external-c-module" class="md-nav__link">Structure of an external C module</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#basic-example" class="md-nav__link">Basic example</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#compiling-the-cmodule-into-micropython" class="md-nav__link">Compiling the cmodule into MicroPython</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#module-usage-in-micropython" class="md-nav__link">Module usage in MicroPython</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="natmod.html" class="md-nav__link">Native machine code in .mpy files</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="porting.html" class="md-nav__link">Porting MicroPython</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../license.html" class="md-nav__link">MicroPython license information</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../pyboard/quickref.html" class="md-nav__link">Quick reference for the pyboard</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../esp8266/quickref.html" class="md-nav__link">Quick reference for the ESP8266</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../esp32/quickref.html" class="md-nav__link">Quick reference for the ESP32</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../rp2/quickref.html" class="md-nav__link">Quick reference for the RP2</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../wipy/quickref.html" class="md-nav__link">Quick reference for the WiPy</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../unix/quickref.html" class="md-nav__link">Quick reference for the UNIX and Windows ports</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../zephyr/quickref.html" class="md-nav__link">Zephyr 适配的快速参考</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#develop-cmodules--page-root" class="md-nav__link">MicroPython external C modules</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#structure-of-an-external-c-module" class="md-nav__link">Structure of an external C module</a>
        </li>
        <li class="md-nav__item"><a href="#basic-example" class="md-nav__link">Basic example</a>
        </li>
        <li class="md-nav__item"><a href="#compiling-the-cmodule-into-micropython" class="md-nav__link">Compiling the cmodule into MicroPython</a>
        </li>
        <li class="md-nav__item"><a href="#module-usage-in-micropython" class="md-nav__link">Module usage in MicroPython</a>
        </li></ul>
            </nav>
        </li>
  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <section id="micropython-external-c-modules">
<span id="cmodules"></span><h1 id="develop-cmodules--page-root">MicroPython external C modules<a class="headerlink" href="#develop-cmodules--page-root" title="永久链接至标题">¶</a></h1>
<p>When developing modules for use with MicroPython you may find you run into
limitations with the Python environment, often due to an inability to access
certain hardware resources or Python speed limitations.</p>
<p>If your limitations can’t be resolved with suggestions in <a class="reference internal" href="../reference/speed_python.html#speed-python"><span class="std std-ref">Maximising MicroPython speed</span></a>,
writing some or all of your module in C (and/or C++ if implemented for your port)
is a viable option.</p>
<p>If your module is designed to access or work with commonly available
hardware or libraries please consider implementing it inside the MicroPython
source tree alongside similar modules and submitting it as a pull request.
If however you’re targeting obscure or proprietary systems it may make
more sense to keep this external to the main MicroPython repository.</p>
<p>This chapter describes how to compile such external modules into the
MicroPython executable or firmware image.  Both Make and CMake build
tools are supported, and when writing an external module it’s a good idea to
add the build files for both of these tools so the module can be used on all
ports.  But when compiling a particular port you will only need to use one
method of building, either Make or CMake.</p>
<p>An alternative approach is to use <a class="reference internal" href="natmod.html#natmod"><span class="std std-ref">Native machine code in .mpy files</span></a> which allows writing custom C
code that is placed in a .mpy file, which can be imported dynamically in to
a running MicroPython system without the need to recompile the main firmware.</p>
<section id="structure-of-an-external-c-module">
<h2 id="structure-of-an-external-c-module">Structure of an external C module<a class="headerlink" href="#structure-of-an-external-c-module" title="永久链接至标题">¶</a></h2>
<p>A MicroPython user C module is a directory with the following files:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">*.c</span></code> / <code class="docutils literal notranslate"><span class="pre">*.cpp</span></code> / <code class="docutils literal notranslate"><span class="pre">*.h</span></code> source code files for your module.</p>
<p>These will typically include the low level functionality being implemented and
the MicroPython binding functions to expose the functions and module(s).</p>
<p>Currently the best reference for writing these functions/modules is
to find similar modules within the MicroPython tree and use them as examples.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">micropython.mk</span></code> contains the Makefile fragment for this module.</p>
<p><code class="docutils literal notranslate"><span class="pre">$(USERMOD_DIR)</span></code> is available in <code class="docutils literal notranslate"><span class="pre">micropython.mk</span></code> as the path to your
module directory. As it’s redefined for each c module, is should be expanded
in your <code class="docutils literal notranslate"><span class="pre">micropython.mk</span></code> to a local make variable,
eg <code class="docutils literal notranslate"><span class="pre">EXAMPLE_MOD_DIR</span> <span class="pre">:=</span> <span class="pre">$(USERMOD_DIR)</span></code></p>
<p>Your <code class="docutils literal notranslate"><span class="pre">micropython.mk</span></code> must add your modules source files relative to your
expanded copy of <code class="docutils literal notranslate"><span class="pre">$(USERMOD_DIR)</span></code> to <code class="docutils literal notranslate"><span class="pre">SRC_USERMOD</span></code>, eg
<code class="docutils literal notranslate"><span class="pre">SRC_USERMOD</span> <span class="pre">+=</span> <span class="pre">$(EXAMPLE_MOD_DIR)/example.c</span></code></p>
<p>If you have custom compiler options (like <code class="docutils literal notranslate"><span class="pre">-I</span></code> to add directories to search
for header files), these should be added to <code class="docutils literal notranslate"><span class="pre">CFLAGS_USERMOD</span></code> for C code
and to <code class="docutils literal notranslate"><span class="pre">CXXFLAGS_USERMOD</span></code> for C++ code.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">micropython.cmake</span></code> contains the CMake configuration for this module.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">micropython.cmake</span></code>, you may use <code class="docutils literal notranslate"><span class="pre">${CMAKE_CURRENT_LIST_DIR}</span></code> as the path to
the current module.</p>
<p>Your <code class="docutils literal notranslate"><span class="pre">micropython.cmake</span></code> should define an <code class="docutils literal notranslate"><span class="pre">INTERFACE</span></code> library and associate
your source files, compile definitions and include directories with it.
The library should then be linked to the <code class="docutils literal notranslate"><span class="pre">usermod</span></code> target.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">add_library</span><span class="p">(</span><span class="s">usermod_cexample</span> <span class="s">INTERFACE</span><span class="p">)</span>

<span class="nb">target_sources</span><span class="p">(</span><span class="s">usermod_cexample</span> <span class="s">INTERFACE</span>
    <span class="o">${</span><span class="nv">CMAKE_CURRENT_LIST_DIR</span><span class="o">}</span><span class="s">/examplemodule.c</span>
<span class="p">)</span>

<span class="nb">target_include_directories</span><span class="p">(</span><span class="s">usermod_cexample</span> <span class="s">INTERFACE</span>
    <span class="o">${</span><span class="nv">CMAKE_CURRENT_LIST_DIR</span><span class="o">}</span>
<span class="p">)</span>

<span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">usermod</span> <span class="s">INTERFACE</span> <span class="s">usermod_cexample</span><span class="p">)</span>
</pre></div>
</div>
<p>See below for full usage example.</p>
</li>
</ul>
</section>
<section id="basic-example">
<h2 id="basic-example">Basic example<a class="headerlink" href="#basic-example" title="永久链接至标题">¶</a></h2>
<p>This simple module named <code class="docutils literal notranslate"><span class="pre">cexample</span></code> provides a single function
<code class="docutils literal notranslate"><span class="pre">cexample.add_ints(a,</span> <span class="pre">b)</span></code> which adds the two integer args together and returns
the result. It can be found in the MicroPython source tree
<a class="reference external" href="https://github.com/micropython/micropython/tree/master/examples/usercmodule/cexample">in the examples directory</a>
and has a source file and a Makefile fragment with content as described above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>micropython/
└──examples/
   └──usercmodule/
      └──cexample/
         ├── examplemodule.c
         ├── micropython.mk
         └── micropython.cmake
</pre></div>
</div>
<p>Refer to the comments in these files for additional explanation.
Next to the <code class="docutils literal notranslate"><span class="pre">cexample</span></code> module there’s also <code class="docutils literal notranslate"><span class="pre">cppexample</span></code> which
works in the same way but shows one way of mixing C and C++ code
in MicroPython.</p>
</section>
<section id="compiling-the-cmodule-into-micropython">
<h2 id="compiling-the-cmodule-into-micropython">Compiling the cmodule into MicroPython<a class="headerlink" href="#compiling-the-cmodule-into-micropython" title="永久链接至标题">¶</a></h2>
<p>To build such a module, compile MicroPython (see <a class="reference external" href="https://github.com/micropython/micropython/wiki/Getting-Started">getting started</a>),
applying 2 modifications:</p>
<ol class="arabic simple">
<li><p>Set the build-time flag <code class="docutils literal notranslate"><span class="pre">USER_C_MODULES</span></code> to point to the modules
you want to include.  For ports that use Make this variable should be a
directory which is searched automatically for modules.  For ports that
use CMake this variable should be a file which includes the modules to
build.  See below for details.</p></li>
<li><p>Enable the modules by setting the corresponding C preprocessor macro to
1.  This is only needed if the modules you are building are not
automatically enabled.</p></li>
</ol>
<p>For building the example modules which come with MicroPython,
set <code class="docutils literal notranslate"><span class="pre">USER_C_MODULES</span></code> to the <code class="docutils literal notranslate"><span class="pre">examples/usercmodule</span></code> directory for Make,
or to <code class="docutils literal notranslate"><span class="pre">examples/usercmodule/micropython.cmake</span></code> for CMake.</p>
<p>For example, here’s how the to build the unix port with the example modules:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> micropython/ports/unix
make <span class="nv">USER_C_MODULES</span><span class="o">=</span>../../examples/usercmodule
</pre></div>
</div>
<p>You may need to run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code> once at the start when including new
user modules in the build.  The build output will show the modules found:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">Including</span> <span class="n">User</span> <span class="n">C</span> <span class="n">Module</span> <span class="kn">from</span> <span class="nn">..</span><span class="o">/../</span><span class="n">examples</span><span class="o">/</span><span class="n">usercmodule</span><span class="o">/</span><span class="n">cexample</span>
<span class="n">Including</span> <span class="n">User</span> <span class="n">C</span> <span class="n">Module</span> <span class="kn">from</span> <span class="nn">..</span><span class="o">/../</span><span class="n">examples</span><span class="o">/</span><span class="n">usercmodule</span><span class="o">/</span><span class="n">cppexample</span>
<span class="o">...</span>
</pre></div>
</div>
<p>For a CMake-based port such as rp2, this will look a little different (note
that CMake is actually invoked by <code class="docutils literal notranslate"><span class="pre">make</span></code>):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> micropython/ports/rp2
make <span class="nv">USER_C_MODULES</span><span class="o">=</span>../../examples/usercmodule/micropython.cmake
</pre></div>
</div>
<p>Again, you may need to run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code> first for CMake to pick up the
user modules.  The CMake build output lists the modules by name:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">Including</span> <span class="n">User</span> <span class="n">C</span> <span class="n">Module</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">..</span><span class="o">/../</span><span class="n">examples</span><span class="o">/</span><span class="n">usercmodule</span><span class="o">/</span><span class="n">micropython</span><span class="o">.</span><span class="n">cmake</span>
<span class="n">Found</span> <span class="n">User</span> <span class="n">C</span> <span class="n">Module</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="n">usermod_cexample</span><span class="p">,</span> <span class="n">usermod_cppexample</span>
<span class="o">...</span>
</pre></div>
</div>
<p>The contents of the top-level <code class="docutils literal notranslate"><span class="pre">micropython.cmake</span></code> can be used to control which
modules are enabled.</p>
<p>For your own projects it’s more convenient to keep custom code out of the main
MicroPython source tree, so a typical project directory structure will look
like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>my_project/
├── modules/
│   ├── example1/
│   │   ├── example1.c
│   │   ├── micropython.mk
│   │   └── micropython.cmake
│   ├── example2/
│   │   ├── example2.c
│   │   ├── micropython.mk
│   │   └── micropython.cmake
│   └── micropython.cmake
└── micropython/
    ├──ports/
   ... ├──stm32/
      ...
</pre></div>
</div>
<p>When building with Make set <code class="docutils literal notranslate"><span class="pre">USER_C_MODULES</span></code> to the <code class="docutils literal notranslate"><span class="pre">my_project/modules</span></code>
directory.  For example, building the stm32 port:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> my_project/micropython/ports/stm32
make <span class="nv">USER_C_MODULES</span><span class="o">=</span>../../../modules
</pre></div>
</div>
<p>When building with CMake the top level <code class="docutils literal notranslate"><span class="pre">micropython.cmake</span></code> – found directly
in the <code class="docutils literal notranslate"><span class="pre">my_project/modules</span></code> directory – should <code class="docutils literal notranslate"><span class="pre">include</span></code> all of the modules
you want to have available:</p>
<blockquote>
<div><div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="nb">include</span><span class="p">(</span><span class="o">${</span><span class="nv">CMAKE_CURRENT_LIST_DIR</span><span class="o">}</span><span class="s">/example1/micropython.cmake</span><span class="p">)</span>
<span class="nb">include</span><span class="p">(</span><span class="o">${</span><span class="nv">CMAKE_CURRENT_LIST_DIR</span><span class="o">}</span><span class="s">/example2/micropython.cmake</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>Then build with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> my_project/micropython/ports/esp32
make <span class="nv">USER_C_MODULES</span><span class="o">=</span>../../../../modules/micropython.cmake
</pre></div>
</div>
<p>Note that the esp32 port needs the extra <code class="docutils literal notranslate"><span class="pre">..</span></code> for relative paths due to the
location of its main <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file.   You can also specify absolute
paths to <code class="docutils literal notranslate"><span class="pre">USER_C_MODULES</span></code>.</p>
<p>All modules specified by the <code class="docutils literal notranslate"><span class="pre">USER_C_MODULES</span></code> variable (either found in this
directory when using Make, or added via <code class="docutils literal notranslate"><span class="pre">include</span></code> when using CMake) will be
compiled, but only those which are enabled will be available for importing.
User modules are usually enabled by default (this is decided by the developer
of the module), in which case there is nothing more to do than set <code class="docutils literal notranslate"><span class="pre">USER_C_MODULES</span></code>
as described above.</p>
<p>If a module is not enabled by default then the corresponding C preprocessor macro
must be enabled.  This macro name can be found by searching for the <code class="docutils literal notranslate"><span class="pre">MP_REGISTER_MODULE</span></code>
line in the module’s source code (it usually appears at the end of the main source file).
The third argument to <code class="docutils literal notranslate"><span class="pre">MP_REGISTER_MODULE</span></code> is the macro name, and this must be set
to 1 using <code class="docutils literal notranslate"><span class="pre">CFLAGS_EXTRA</span></code> to make the module available.  If the third argument is just
the number 1 then the module is enabled by default.</p>
<p>For example, the <code class="docutils literal notranslate"><span class="pre">examples/usercmodule/cexample</span></code> module is enabled by default so
has the following line in its source code:</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">MP_REGISTER_MODULE</span><span class="p">(</span><span class="n">MP_QSTR_cexample</span><span class="p">,</span> <span class="n">example_user_cmodule</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<p>Alternatively, to make this module disabled by default but selectable through
a preprocessor configuration option, it would be:</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">MP_REGISTER_MODULE</span><span class="p">(</span><span class="n">MP_QSTR_cexample</span><span class="p">,</span> <span class="n">example_user_cmodule</span><span class="p">,</span> <span class="n">MODULE_CEXAMPLE_ENABLED</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
<p>In this case the module is enabled by adding <code class="docutils literal notranslate"><span class="pre">CFLAGS_EXTRA=-DMODULE_CEXAMPLE_ENABLED=1</span></code>
to the <code class="docutils literal notranslate"><span class="pre">make</span></code> command, or editing <code class="docutils literal notranslate"><span class="pre">mpconfigport.h</span></code> or <code class="docutils literal notranslate"><span class="pre">mpconfigboard.h</span></code> to add</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define MODULE_CEXAMPLE_ENABLED (1)</span>
</pre></div>
</div>
</div></blockquote>
<p>Note that the exact method depends on the port as they have different
structures.  If not done correctly it will compile but importing will
fail to find the module.</p>
</section>
<section id="module-usage-in-micropython">
<h2 id="module-usage-in-micropython">Module usage in MicroPython<a class="headerlink" href="#module-usage-in-micropython" title="永久链接至标题">¶</a></h2>
<p>Once built into your copy of MicroPython, the module
can now be accessed in Python just like any other builtin module, e.g.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cexample</span>
<span class="k">print</span><span class="p">(</span><span class="n">cexample</span><span class="o">.</span><span class="n">add_ints</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="c1"># should display 4</span>
</pre></div>
</div>
</section>
</section>


          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="extendingmicropython.html" title="Extending MicroPython in C"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> Extending MicroPython in C </span>
              </div>
            </a>
          
          
            <a href="natmod.html" title="Native machine code in .mpy files"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> Next </span> Native machine code in .mpy files </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright - The MicroPython Documentation is Copyright © 2014-2022, Damien P. George, Paul Sokolovsky, and contributors.
              
          </div>
            Last updated on
              11 2月 2022.
            <br/>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>