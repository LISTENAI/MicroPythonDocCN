
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>MicroPython .mpy files &#8212; MicroPython 1.18 文档</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/material.css" />
    <link rel="stylesheet" href="../_static/customstyle.css" type="text/css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/translations.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="Writing interrupt handlers" href="isr_rules.html" />
    <link rel="prev" title="MicroPython remote control: mpremote" href="mpremote.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=blue data-md-color-accent=light-blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#reference/mpyfiles" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../index.html" title="MicroPython 1.18 文档"
           class="md-header-nav__button md-logo">
          
            &nbsp;
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">MicroPython 1.18 文档</span>
          <span class="md-header-nav__topic"> MicroPython .mpy files </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
      
  
  <script src="../_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../"versions.json"",
        target_loc = "../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="../index.html" class="md-tabs__link">MicroPython 1.18 文档</a></li>
          <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">MicroPython language and implementation</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../index.html" title="MicroPython 1.18 文档" class="md-nav__button md-logo">
      
        <img src="../_static/" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../index.html"
       title="MicroPython 1.18 文档">MicroPython 1.18 文档</a>
  </label>
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
    
      <a href="../library/index.html" class="md-nav__link">MicroPython libraries</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="index.html" class="md-nav__link">MicroPython language and implementation</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="glossary.html" class="md-nav__link">Glossary</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="repl.html" class="md-nav__link">The MicroPython Interactive Interpreter Mode (aka REPL)</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="mpremote.html" class="md-nav__link">MicroPython remote control: mpremote</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    <label class="md-nav__link md-nav__link--active" for="__toc"> MicroPython .mpy files </label>
    
      <a href="#" class="md-nav__link md-nav__link--active">MicroPython .mpy files</a>
      
        
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#reference-mpyfiles--page-root" class="md-nav__link">MicroPython .mpy files</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#versioning-and-compatibility-of-mpy-files" class="md-nav__link">Versioning and compatibility of .mpy files</a>
        </li>
        <li class="md-nav__item"><a href="#binary-encoding-of-mpy-files" class="md-nav__link">Binary encoding of .mpy files</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#the-header" class="md-nav__link">The header</a>
        </li>
        <li class="md-nav__item"><a href="#raw-code-elements" class="md-nav__link">Raw code elements</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
  </ul>
</nav>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#versioning-and-compatibility-of-mpy-files" class="md-nav__link">Versioning and compatibility of .mpy files</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#binary-encoding-of-mpy-files" class="md-nav__link">Binary encoding of .mpy files</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#the-header" class="md-nav__link">The header</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#raw-code-elements" class="md-nav__link">Raw code elements</a>
      
    
    </li></ul>
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="isr_rules.html" class="md-nav__link">Writing interrupt handlers</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="speed_python.html" class="md-nav__link">Maximising MicroPython speed</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="constrained.html" class="md-nav__link">MicroPython on microcontrollers</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="manifest.html" class="md-nav__link">MicroPython manifest files</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="packages.html" class="md-nav__link">Distribution packages, package management, and deploying applications</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="asm_thumb2_index.html" class="md-nav__link">Inline assembler for Thumb2 architectures</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="filesystem.html" class="md-nav__link">Working with filesystems</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="pyboard.py.html" class="md-nav__link">The pyboard.py tool</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../genrst/index.html" class="md-nav__link">MicroPython differences from CPython</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../develop/index.html" class="md-nav__link">MicroPython Internals</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../license.html" class="md-nav__link">MicroPython license information</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../pyboard/quickref.html" class="md-nav__link">Quick reference for the pyboard</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../esp8266/quickref.html" class="md-nav__link">Quick reference for the ESP8266</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../esp32/quickref.html" class="md-nav__link">Quick reference for the ESP32</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../rp2/quickref.html" class="md-nav__link">Quick reference for the RP2</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../wipy/quickref.html" class="md-nav__link">Quick reference for the WiPy</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../unix/quickref.html" class="md-nav__link">Quick reference for the UNIX and Windows ports</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../zephyr/quickref.html" class="md-nav__link">Zephyr 适配的快速参考</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#reference-mpyfiles--page-root" class="md-nav__link">MicroPython .mpy files</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#versioning-and-compatibility-of-mpy-files" class="md-nav__link">Versioning and compatibility of .mpy files</a>
        </li>
        <li class="md-nav__item"><a href="#binary-encoding-of-mpy-files" class="md-nav__link">Binary encoding of .mpy files</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#the-header" class="md-nav__link">The header</a>
        </li>
        <li class="md-nav__item"><a href="#raw-code-elements" class="md-nav__link">Raw code elements</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <section id="micropython-mpy-files">
<span id="mpy-files"></span><h1 id="reference-mpyfiles--page-root">MicroPython .mpy files<a class="headerlink" href="#reference-mpyfiles--page-root" title="永久链接至标题">¶</a></h1>
<p>MicroPython defines the concept of an .mpy file which is a binary container
file format that holds precompiled code, and which can be imported like a
normal .py module.  The file <code class="docutils literal notranslate"><span class="pre">foo.mpy</span></code> can be imported via <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">foo</span></code>,
as long as <code class="docutils literal notranslate"><span class="pre">foo.mpy</span></code> can be found in the usual way by the import machinery.
Usually, each directory listed in <code class="docutils literal notranslate"><span class="pre">sys.path</span></code> is searched in order.  When
searching a particular directory <code class="docutils literal notranslate"><span class="pre">foo.py</span></code> is looked for first and if that
is not found then <code class="docutils literal notranslate"><span class="pre">foo.mpy</span></code> is looked for, then the search continues in the
next directory if neither is found.  As such, <code class="docutils literal notranslate"><span class="pre">foo.py</span></code> will take precedence
over <code class="docutils literal notranslate"><span class="pre">foo.mpy</span></code>.</p>
<p>These .mpy files can contain bytecode which is usually generated from Python
source files (.py files) via the <code class="docutils literal notranslate"><span class="pre">mpy-cross</span></code> program.  For some architectures
an .mpy file can also contain native machine code, which can be generated in
a variety of ways, most notably from C source code.</p>
<section id="versioning-and-compatibility-of-mpy-files">
<h2 id="versioning-and-compatibility-of-mpy-files">Versioning and compatibility of .mpy files<a class="headerlink" href="#versioning-and-compatibility-of-mpy-files" title="永久链接至标题">¶</a></h2>
<p>A given .mpy file may or may not be compatible with a given MicroPython system.
Compatibility is based on the following:</p>
<ul class="simple">
<li><p>Version of the .mpy file: the version of the file must match the version
supported by the system loading it.</p></li>
<li><p>Bytecode features used in the .mpy file: there are two bytecode features
which must match between the file and the system: unicode support and
inline caching of map lookups in the bytecode.</p></li>
<li><p>Small integer bits: the .mpy file will require a minimum number of bits in
a small integer and the system loading it must support at least this many
bits.</p></li>
<li><p>Qstr compression window size: the .mpy file will require a minimum window
size for qstr decompression and the system loading it must have a window
greater or equal to this size.</p></li>
<li><p>Native architecture: if the .mpy file contains native machine code then
it will specify the architecture of that machine code and the system
loading it must support execution of that architecture’s code.</p></li>
</ul>
<p>If a MicroPython system supports importing .mpy files then the
<code class="docutils literal notranslate"><span class="pre">sys.implementation.mpy</span></code> field will exist and return an integer which
encodes the version (lower 8 bits), features and native architecture.</p>
<p>Trying to import an .mpy file that fails one of the first four tests will
raise <code class="docutils literal notranslate"><span class="pre">ValueError('incompatible</span> <span class="pre">.mpy</span> <span class="pre">file')</span></code>.  Trying to import an .mpy
file that fails the native architecture test (if it contains native machine
code) will raise <code class="docutils literal notranslate"><span class="pre">ValueError('incompatible</span> <span class="pre">.mpy</span> <span class="pre">arch')</span></code>.</p>
<p>If importing an .mpy file fails then try the following:</p>
<ul>
<li><p>Determine the .mpy version and flags supported by your MicroPython system
by executing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys_mpy</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">implementation</span><span class="o">.</span><span class="n">mpy</span>
<span class="n">arch</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">'x86'</span><span class="p">,</span> <span class="s1">'x64'</span><span class="p">,</span>
    <span class="s1">'armv6'</span><span class="p">,</span> <span class="s1">'armv6m'</span><span class="p">,</span> <span class="s1">'armv7m'</span><span class="p">,</span> <span class="s1">'armv7em'</span><span class="p">,</span> <span class="s1">'armv7emsp'</span><span class="p">,</span> <span class="s1">'armv7emdp'</span><span class="p">,</span>
    <span class="s1">'xtensa'</span><span class="p">,</span> <span class="s1">'xtensawin'</span><span class="p">][</span><span class="n">sys_mpy</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'mpy version:'</span><span class="p">,</span> <span class="n">sys_mpy</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'mpy flags:'</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
<span class="k">if</span> <span class="n">arch</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">' -march='</span> <span class="o">+</span> <span class="n">arch</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">sys_mpy</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">' -mno-unicode'</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>Check the validity of the .mpy file by inspecting the first two bytes of
the file.  The first byte should be an uppercase ‘M’ and the second byte
will be the version number, which should match the system version from above.
If it doesn’t match then rebuild the .mpy file.</p></li>
<li><p>Check if the system .mpy version matches the version emitted by <code class="docutils literal notranslate"><span class="pre">mpy-cross</span></code>
that was used to build the .mpy file, found by <code class="docutils literal notranslate"><span class="pre">mpy-cross</span> <span class="pre">--version</span></code>.
If it doesn’t match then recompile <code class="docutils literal notranslate"><span class="pre">mpy-cross</span></code> from the Git repository
checked out at the tag (or hash) reported by <code class="docutils literal notranslate"><span class="pre">mpy-cross</span> <span class="pre">--version</span></code>.</p></li>
<li><p>Make sure you are using the correct <code class="docutils literal notranslate"><span class="pre">mpy-cross</span></code> flags, found by the code
above, or by inspecting the <code class="docutils literal notranslate"><span class="pre">MPY_CROSS_FLAGS</span></code> Makefile variable for the
port that you are using.</p></li>
</ul>
<p>The following table shows the correspondence between MicroPython release
and .mpy version.</p>
<table>
<colgroup>
<col style="width: 61%"/>
<col style="width: 39%"/>
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>MicroPython release</p></th>
<th class="head"><p>.mpy version</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>v1.12 and up</p></td>
<td><p>5</p></td>
</tr>
<tr class="row-odd"><td><p>v1.11</p></td>
<td><p>4</p></td>
</tr>
<tr class="row-even"><td><p>v1.9.3 - v1.10</p></td>
<td><p>3</p></td>
</tr>
<tr class="row-odd"><td><p>v1.9 - v1.9.2</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><p>v1.5.1 - v1.8.7</p></td>
<td><p>0</p></td>
</tr>
</tbody>
</table>
<p>For completeness, the next table shows the Git commit of the main
MicroPython repository at which the .mpy version was changed.</p>
<table>
<colgroup>
<col style="width: 32%"/>
<col style="width: 68%"/>
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>.mpy version change</p></th>
<th class="head"><p>Git commit</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>4 to 5</p></td>
<td><p>5716c5cf65e9b2cb46c2906f40302401bdd27517</p></td>
</tr>
<tr class="row-odd"><td><p>3 to 4</p></td>
<td><p>9a5f92ea72754c01cc03e5efcdfe94021120531e</p></td>
</tr>
<tr class="row-even"><td><p>2 to 3</p></td>
<td><p>ff93fd4f50321c6190e1659b19e64fef3045a484</p></td>
</tr>
<tr class="row-odd"><td><p>1 to 2</p></td>
<td><p>dd11af209d226b7d18d5148b239662e30ed60bad</p></td>
</tr>
<tr class="row-even"><td><p>0 to 1</p></td>
<td><p>6a11048af1d01c78bdacddadd1b72dc7ba7c6478</p></td>
</tr>
<tr class="row-odd"><td><p>initial version 0</p></td>
<td><p>d8c834c95d506db979ec871417de90b7951edc30</p></td>
</tr>
</tbody>
</table>
</section>
<section id="binary-encoding-of-mpy-files">
<h2 id="binary-encoding-of-mpy-files">Binary encoding of .mpy files<a class="headerlink" href="#binary-encoding-of-mpy-files" title="永久链接至标题">¶</a></h2>
<p>MicroPython .mpy files are a binary container format with code objects
stored internally in a nested hierarchy.  To keep files small while still
providing a large range of possible values it uses the concept of a
variably-encoded-unsigned-integer (vuint) in many places.  Similar to utf-8
encoding, this encoding stores 7 bits per byte with the 8th bit (MSB) set
if one or more bytes follow.  The bits of the unsigned integer are stored
in the vuint in LSB form.</p>
<p>The top-level of an .mpy file consists of two parts:</p>
<ul class="simple">
<li><p>The header.</p></li>
<li><p>The raw-code for the outer scope of the module.
This outer scope is executed when the .mpy file is imported.</p></li>
</ul>
<section id="the-header">
<h3 id="the-header">The header<a class="headerlink" href="#the-header" title="永久链接至标题">¶</a></h3>
<p>The .mpy header is:</p>
<table>
<colgroup>
<col style="width: 16%"/>
<col style="width: 84%"/>
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>size</p></th>
<th class="head"><p>field</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>byte</p></td>
<td><p>value 0x4d (ASCII ‘M’)</p></td>
</tr>
<tr class="row-odd"><td><p>byte</p></td>
<td><p>.mpy version number</p></td>
</tr>
<tr class="row-even"><td><p>byte</p></td>
<td><p>feature flags</p></td>
</tr>
<tr class="row-odd"><td><p>byte</p></td>
<td><p>number of bits in a small int</p></td>
</tr>
<tr class="row-even"><td><p>vuint</p></td>
<td><p>size of qstr window</p></td>
</tr>
</tbody>
</table>
</section>
<section id="raw-code-elements">
<h3 id="raw-code-elements">Raw code elements<a class="headerlink" href="#raw-code-elements" title="永久链接至标题">¶</a></h3>
<p>A raw-code element contains code, either bytecode or native machine code.  Its
contents are:</p>
<table>
<colgroup>
<col style="width: 16%"/>
<col style="width: 84%"/>
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>size</p></th>
<th class="head"><p>field</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>vuint</p></td>
<td><p>type and size</p></td>
</tr>
<tr class="row-odd"><td><p>…</p></td>
<td><p>code (bytecode or machine code)</p></td>
</tr>
<tr class="row-even"><td><p>vuint</p></td>
<td><p>number of constant objects</p></td>
</tr>
<tr class="row-odd"><td><p>vuint</p></td>
<td><p>number of sub-raw-code elements</p></td>
</tr>
<tr class="row-even"><td><p>…</p></td>
<td><p>constant objects</p></td>
</tr>
<tr class="row-odd"><td><p>…</p></td>
<td><p>sub-raw-code elements</p></td>
</tr>
</tbody>
</table>
<p>The first vuint in a raw-code element encodes the type of code stored in this
element (the two least-significant bits), and the decompressed length of the code
(the amount of RAM to allocate for it).</p>
<p>Following the vuint comes the code itself.  In the case of bytecode it also contains
compressed qstr values.</p>
<p>Following the code comes a vuint counting the number of constant objects, and
another vuint counting the number of sub-raw-code elements.</p>
<p>The constant objects are then stored next.</p>
<p>Finally any sub-raw-code elements are stored, recursively.</p>
</section>
</section>
</section>


          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="mpremote.html" title="MicroPython remote control: mpremote"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> MicroPython remote control: mpremote </span>
              </div>
            </a>
          
          
            <a href="isr_rules.html" title="Writing interrupt handlers"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> Next </span> Writing interrupt handlers </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright - The MicroPython Documentation is Copyright © 2014-2022, Damien P. George, Paul Sokolovsky, and contributors.
              
          </div>
            Last updated on
              23 2月 2022.
            <br/>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>