
<!DOCTYPE html>

<html lang="zh_CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>Working with filesystems &#8212; MicroPython 1.18 文档</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/material.css" />
    <link rel="stylesheet" href="../_static/customstyle.css" type="text/css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/translations.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="The pyboard.py tool" href="pyboard.py.html" />
    <link rel="prev" title="1. Hints and tips" href="asm_thumb2_hints_tips.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=blue-grey data-md-color-accent=blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#reference/filesystem" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../index.html" title="MicroPython 1.18 文档"
           class="md-header-nav__button md-logo">
          
            &nbsp;
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">MicroPython 1.18 文档</span>
          <span class="md-header-nav__topic"> Working with filesystems </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
      
  
  <script src="../_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../"versions.json"",
        target_loc = "../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="../index.html" class="md-tabs__link">MicroPython 1.18 文档</a></li>
          <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">MicroPython language and implementation</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../index.html" title="MicroPython 1.18 文档" class="md-nav__button md-logo">
      
        <img src="../_static/" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../index.html"
       title="MicroPython 1.18 文档">MicroPython 1.18 文档</a>
  </label>
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
    
      <a href="../library/index.html" class="md-nav__link">MicroPython libraries</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="index.html" class="md-nav__link">MicroPython language and implementation</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../genrst/index.html" class="md-nav__link">MicroPython differences from CPython</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../develop/index.html" class="md-nav__link">MicroPython Internals</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../license.html" class="md-nav__link">MicroPython license information</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../pyboard/quickref.html" class="md-nav__link">Quick reference for the pyboard</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../esp8266/quickref.html" class="md-nav__link">Quick reference for the ESP8266</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../esp32/quickref.html" class="md-nav__link">Quick reference for the ESP32</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../rp2/quickref.html" class="md-nav__link">Quick reference for the RP2</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../wipy/quickref.html" class="md-nav__link">Quick reference for the WiPy</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../unix/quickref.html" class="md-nav__link">Quick reference for the UNIX and Windows ports</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../zephyr/quickref.html" class="md-nav__link">Quick reference for the Zephyr port</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#reference-filesystem--page-root" class="md-nav__link">Working with filesystems</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#vfs" class="md-nav__link">VFS</a>
        </li>
        <li class="md-nav__item"><a href="#block-devices" class="md-nav__link">Block devices</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#built-in-block-devices" class="md-nav__link">Built-in block devices</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#stm32-pyboard" class="md-nav__link">STM32 / Pyboard</a>
        </li>
        <li class="md-nav__item"><a href="#esp8266" class="md-nav__link">ESP8266</a>
        </li>
        <li class="md-nav__item"><a href="#esp32" class="md-nav__link">ESP32</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#custom-block-devices" class="md-nav__link">Custom block devices</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#filesystems" class="md-nav__link">Filesystems</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#fat" class="md-nav__link">FAT</a>
        </li>
        <li class="md-nav__item"><a href="#littlefs" class="md-nav__link">Littlefs</a>
        </li>
        <li class="md-nav__item"><a href="#hybrid-stm32" class="md-nav__link">Hybrid (STM32)</a>
        </li>
        <li class="md-nav__item"><a href="#hybrid-esp32" class="md-nav__link">Hybrid (ESP32)</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <section id="working-with-filesystems">
<span id="filesystem"></span><h1 id="reference-filesystem--page-root"><a class="toc-backref" href="#reference-filesystem--page-root">Working with filesystems</a><a class="headerlink" href="#reference-filesystem--page-root" title="永久链接至标题">¶</a></h1>
<div class="contents topic" id="id1">
<p class="topic-title">目录</p>
<ul class="simple">
<li><p><a class="reference internal" href="#working-with-filesystems" id="id3">Working with filesystems</a></p>
<ul>
<li><p><a class="reference internal" href="#vfs" id="id4">VFS</a></p></li>
<li><p><a class="reference internal" href="#block-devices" id="id5">Block devices</a></p>
<ul>
<li><p><a class="reference internal" href="#built-in-block-devices" id="id6">Built-in block devices</a></p>
<ul>
<li><p><a class="reference internal" href="#stm32-pyboard" id="id7">STM32 / Pyboard</a></p></li>
<li><p><a class="reference internal" href="#esp8266" id="id8">ESP8266</a></p></li>
<li><p><a class="reference internal" href="#esp32" id="id9">ESP32</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#custom-block-devices" id="id10">Custom block devices</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#filesystems" id="id11">Filesystems</a></p>
<ul>
<li><p><a class="reference internal" href="#fat" id="id12">FAT</a></p></li>
<li><p><a class="reference internal" href="#littlefs" id="id13">Littlefs</a></p></li>
<li><p><a class="reference internal" href="#hybrid-stm32" id="id14">Hybrid (STM32)</a></p></li>
<li><p><a class="reference internal" href="#hybrid-esp32" id="id15">Hybrid (ESP32)</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p>This tutorial describes how MicroPython provides an on-device filesystem,
allowing standard Python file I/O methods to be used with persistent storage.</p>
<p>MicroPython automatically creates a default configuration and auto-detects the
primary filesystem, so this tutorial will be mostly useful if you want to modify
the partitioning, filesystem type, or use custom block devices.</p>
<p>The filesystem is typically backed by internal flash memory on the device, but
can also use external flash, RAM, or a custom block device.</p>
<p>On some ports (e.g. STM32), the filesystem may also be available over USB MSC to
a host PC. <a class="reference internal" href="pyboard.py.html#pyboard-py"><span class="std std-ref">The pyboard.py tool</span></a> also provides a way for the host PC to access to
the filesystem on all ports.</p>
<p>Note: This is mainly for use on bare-metal ports like STM32 and ESP32. On ports
with an operating system (e.g. the Unix port) the filesystem is provided by the
host OS.</p>
<section id="vfs">
<h2 id="vfs"><a class="toc-backref" href="#id4">VFS</a><a class="headerlink" href="#vfs" title="永久链接至标题">¶</a></h2>
<p>MicroPython implements a Unix-like Virtual File System (VFS) layer. All mounted
filesystems are combined into a single virtual filesystem, starting at the root
<code class="docutils literal notranslate"><span class="pre">/</span></code>. Filesystems are mounted into directories in this structure, and at
startup the working directory is changed to where the primary filesystem is
mounted.</p>
<p>On STM32 / Pyboard, the internal flash is mounted at <code class="docutils literal notranslate"><span class="pre">/flash</span></code>, and optionally
the SDCard at <code class="docutils literal notranslate"><span class="pre">/sd</span></code>. On ESP8266/ESP32, the primary filesystem is mounted at
<code class="docutils literal notranslate"><span class="pre">/</span></code>.</p>
</section>
<section id="block-devices">
<h2 id="block-devices"><a class="toc-backref" href="#id5">Block devices</a><a class="headerlink" href="#block-devices" title="永久链接至标题">¶</a></h2>
<p>A block device is an instance of a class that implements the
<a class="reference internal" href="../library/os.html#os.AbstractBlockDev" title="os.AbstractBlockDev"><code class="xref py py-class docutils literal notranslate"><span class="pre">os.AbstractBlockDev</span></code></a> protocol.</p>
<section id="built-in-block-devices">
<h3 id="built-in-block-devices"><a class="toc-backref" href="#id6">Built-in block devices</a><a class="headerlink" href="#built-in-block-devices" title="永久链接至标题">¶</a></h3>
<p>Ports provide built-in block devices to access their primary flash.</p>
<p>On power-on, MicroPython will attempt to detect the filesystem on the default
flash and configure and mount it automatically. If no filesystem is found,
MicroPython will attempt to create a FAT filesystem spanning the entire flash.
Ports can also provide a mechanism to “factory reset” the primary flash, usually
by some combination of button presses at power on.</p>
<section id="stm32-pyboard">
<h4 id="stm32-pyboard"><a class="toc-backref" href="#id7">STM32 / Pyboard</a><a class="headerlink" href="#stm32-pyboard" title="永久链接至标题">¶</a></h4>
<p>The <a class="reference internal" href="../library/pyb.Flash.html#pyb-flash"><span class="std std-ref">pyb.Flash</span></a> class provides access to the internal flash. On some
boards which have larger external flash (e.g. Pyboard D), it will use that
instead. The <code class="docutils literal notranslate"><span class="pre">start</span></code> kwarg should always be specified, i.e.
<code class="docutils literal notranslate"><span class="pre">pyb.Flash(start=0)</span></code>.</p>
<p>Note: For backwards compatibility, when constructed with no arguments (i.e.
<code class="docutils literal notranslate"><span class="pre">pyb.Flash()</span></code>), it only implements the simple block interface and reflects the
virtual device presented to USB MSC (i.e. it includes a virtual partition table
at the start).</p>
</section>
<section id="esp8266">
<h4 id="esp8266"><a class="toc-backref" href="#id8">ESP8266</a><a class="headerlink" href="#esp8266" title="永久链接至标题">¶</a></h4>
<p>The internal flash is exposed as a block device object which is created in the
<code class="docutils literal notranslate"><span class="pre">flashbdev</span></code> module on start up. This object is by default added as a global
variable so it can usually be accessed simply as <code class="docutils literal notranslate"><span class="pre">bdev</span></code>. This implements the
extended interface.</p>
</section>
<section id="esp32">
<h4 id="esp32"><a class="toc-backref" href="#id9">ESP32</a><a class="headerlink" href="#esp32" title="永久链接至标题">¶</a></h4>
<p>The <a class="reference internal" href="../library/esp32.html#esp32.Partition" title="esp32.Partition"><code class="xref py py-class docutils literal notranslate"><span class="pre">esp32.Partition</span></code></a> class implements a block device for partitions
defined for the board. Like ESP8266, there is a global variable <code class="docutils literal notranslate"><span class="pre">bdev</span></code> which
points to the default partition. This implements the extended interface.</p>
</section>
</section>
<section id="custom-block-devices">
<h3 id="custom-block-devices"><a class="toc-backref" href="#id10">Custom block devices</a><a class="headerlink" href="#custom-block-devices" title="永久链接至标题">¶</a></h3>
<p>The following class implements a simple block device that stores its data in
RAM using a <code class="docutils literal notranslate"><span class="pre">bytearray</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RAMBlockDev</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_size</span><span class="p">,</span> <span class="n">num_blocks</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">block_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">block_size</span> <span class="o">*</span> <span class="n">num_blocks</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readblocks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_num</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)):</span>
            <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">block_num</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">writeblocks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_num</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">block_num</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">ioctl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># get number of blocks</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span> <span class="c1"># get block size</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span>
</pre></div>
</div>
<p>It can be used as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="n">bdev</span> <span class="o">=</span> <span class="n">RAMBlockDev</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">VfsFat</span><span class="o">.</span><span class="n">mkfs</span><span class="p">(</span><span class="n">bdev</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="s1">'/ramdisk'</span><span class="p">)</span>
</pre></div>
</div>
<p>An example of a block device that supports both the simple and extended
interface (i.e. both signatures and behaviours of the
<a class="reference internal" href="../library/os.html#os.AbstractBlockDev.readblocks" title="os.AbstractBlockDev.readblocks"><code class="xref py py-meth docutils literal notranslate"><span class="pre">os.AbstractBlockDev.readblocks()</span></code></a> and
<a class="reference internal" href="../library/os.html#os.AbstractBlockDev.writeblocks" title="os.AbstractBlockDev.writeblocks"><code class="xref py py-meth docutils literal notranslate"><span class="pre">os.AbstractBlockDev.writeblocks()</span></code></a> methods) is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RAMBlockDev</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_size</span><span class="p">,</span> <span class="n">num_blocks</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">block_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">block_size</span> <span class="o">*</span> <span class="n">num_blocks</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readblocks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_num</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">block_num</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span> <span class="o">+</span> <span class="n">offset</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)):</span>
            <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">writeblocks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block_num</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># do erase, then write</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">block_num</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">block_num</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span> <span class="o">+</span> <span class="n">offset</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">ioctl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span> <span class="c1"># block count</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span> <span class="c1"># block size</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_size</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span> <span class="c1"># block erase</span>
            <span class="k">return</span> <span class="mi">0</span>
</pre></div>
</div>
<p>As it supports the extended interface, it can be used with <a class="reference internal" href="../library/os.html#os.VfsLfs2" title="os.VfsLfs2"><code class="xref py py-class docutils literal notranslate"><span class="pre">littlefs</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="n">bdev</span> <span class="o">=</span> <span class="n">RAMBlockDev</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">VfsLfs2</span><span class="o">.</span><span class="n">mkfs</span><span class="p">(</span><span class="n">bdev</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="s1">'/ramdisk'</span><span class="p">)</span>
</pre></div>
</div>
<p>Once mounted, the filesystem (regardless of its type) can be used as it
normally would be used from Python code, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'/ramdisk/hello.txt'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'Hello world'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">'/ramdisk/hello.txt'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
</section>
</section>
<section id="filesystems">
<h2 id="filesystems"><a class="toc-backref" href="#id11">Filesystems</a><a class="headerlink" href="#filesystems" title="永久链接至标题">¶</a></h2>
<p>MicroPython ports can provide implementations of <a class="reference internal" href="../library/os.html#os.VfsFat" title="os.VfsFat"><code class="xref py py-class docutils literal notranslate"><span class="pre">FAT</span></code></a>,
<a class="reference internal" href="../library/os.html#os.VfsLfs1" title="os.VfsLfs1"><code class="xref py py-class docutils literal notranslate"><span class="pre">littlefs</span> <span class="pre">v1</span></code></a> and <a class="reference internal" href="../library/os.html#os.VfsLfs2" title="os.VfsLfs2"><code class="xref py py-class docutils literal notranslate"><span class="pre">littlefs</span> <span class="pre">v2</span></code></a>.</p>
<p>The following table shows which filesystems are included in the firmware by
default for given port/board combinations, however they can be optionally
enabled in a custom firmware build.</p>
<table>
<colgroup>
<col style="width: 43%"/>
<col style="width: 11%"/>
<col style="width: 23%"/>
<col style="width: 23%"/>
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Board</p></th>
<th class="head"><p>FAT</p></th>
<th class="head"><p>littlefs v1</p></th>
<th class="head"><p>littlefs v2</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>pyboard 1.0, 1.1, D</p></td>
<td><p>Yes</p></td>
<td><p>No</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p>Other STM32</p></td>
<td><p>Yes</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p>ESP8266 (1M)</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p>ESP8266 (2M+)</p></td>
<td><p>Yes</p></td>
<td><p>No</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p>ESP32</p></td>
<td><p>Yes</p></td>
<td><p>No</p></td>
<td><p>Yes</p></td>
</tr>
</tbody>
</table>
<section id="fat">
<h3 id="fat"><a class="toc-backref" href="#id12">FAT</a><a class="headerlink" href="#fat" title="永久链接至标题">¶</a></h3>
<p>The main advantage of the FAT filesystem is that it can be accessed over USB MSC
on supported boards (e.g. STM32) without any additional drivers required on the
host PC.</p>
<p>However, FAT is not tolerant to power failure during writes and this can lead to
filesystem corruption. For applications that do not require USB MSC, it is
recommended to use littlefs instead.</p>
<p>To format the entire flash using FAT:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ESP8266 and ESP32</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">umount</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">VfsFat</span><span class="o">.</span><span class="n">mkfs</span><span class="p">(</span><span class="n">bdev</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">)</span>

<span class="c1"># STM32</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">pyb</span>
<span class="n">os</span><span class="o">.</span><span class="n">umount</span><span class="p">(</span><span class="s1">'/flash'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">VfsFat</span><span class="o">.</span><span class="n">mkfs</span><span class="p">(</span><span class="n">pyb</span><span class="o">.</span><span class="n">Flash</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">os</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="n">pyb</span><span class="o">.</span><span class="n">Flash</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s1">'/flash'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">'/flash'</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="littlefs">
<h3 id="littlefs"><a class="toc-backref" href="#id13">Littlefs</a><a class="headerlink" href="#littlefs" title="永久链接至标题">¶</a></h3>
<p><a class="reference external" href="https://github.com/littlefs-project/littlefs">Littlefs</a> is a filesystem designed for flash-based devices, and is much more
resistant to filesystem corruption.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>There are reports of littlefs v1 and v2 failing in certain
situations, for details see <a class="reference external" href="https://github.com/littlefs-project/littlefs/issues/347">littlefs issue 347</a>  and
<a class="reference external" href="https://github.com/littlefs-project/littlefs/issues/295">littlefs issue 295</a>.</p>
</div>
<p>To format the entire flash using littlefs v2:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ESP8266 and ESP32</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">umount</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">VfsLfs2</span><span class="o">.</span><span class="n">mkfs</span><span class="p">(</span><span class="n">bdev</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="n">bdev</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">)</span>

<span class="c1"># STM32</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">pyb</span>
<span class="n">os</span><span class="o">.</span><span class="n">umount</span><span class="p">(</span><span class="s1">'/flash'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">VfsLfs2</span><span class="o">.</span><span class="n">mkfs</span><span class="p">(</span><span class="n">pyb</span><span class="o">.</span><span class="n">Flash</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">os</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="n">pyb</span><span class="o">.</span><span class="n">Flash</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s1">'/flash'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">'/flash'</span><span class="p">)</span>
</pre></div>
</div>
<p>A littlefs filesystem can be still be accessed on a PC over USB MSC using the
<a class="reference external" href="https://github.com/littlefs-project/littlefs-fuse">littlefs FUSE driver</a>.  Note that you must specify both the <code class="docutils literal notranslate"><span class="pre">--block_size</span></code>
and <code class="docutils literal notranslate"><span class="pre">--block_count</span></code> options to override the defaults.  For example (after
building the littlefs-fuse executable):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ./lfs --block_size=4096 --block_count=512 -o allow_other /dev/sdb1 mnt
</pre></div>
</div>
<p>This will allow the board’s littlefs filesystem to be accessed at the <code class="docutils literal notranslate"><span class="pre">mnt</span></code>
directory.  To get the correct values of <code class="docutils literal notranslate"><span class="pre">block_size</span></code> and <code class="docutils literal notranslate"><span class="pre">block_count</span></code> use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyb</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">pyb</span><span class="o">.</span><span class="n">Flash</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># initialise flash in littlefs raw-block mode</span>
<span class="n">block_count</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">block_size</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">ioctl</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="hybrid-stm32">
<h3 id="hybrid-stm32"><a class="toc-backref" href="#id14">Hybrid (STM32)</a><a class="headerlink" href="#hybrid-stm32" title="永久链接至标题">¶</a></h3>
<p>By using the <code class="docutils literal notranslate"><span class="pre">start</span></code> and <code class="docutils literal notranslate"><span class="pre">len</span></code> kwargs to <code class="xref py py-class docutils literal notranslate"><span class="pre">pyb.Flash</span></code>, you can create
block devices spanning a subset of the flash device.</p>
<p>For example, to configure the first 256kiB as FAT (and available over USB MSC),
and the remainder as littlefs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">pyb</span>
<span class="n">os</span><span class="o">.</span><span class="n">umount</span><span class="p">(</span><span class="s1">'/flash'</span><span class="p">)</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">pyb</span><span class="o">.</span><span class="n">Flash</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="o">=</span><span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">pyb</span><span class="o">.</span><span class="n">Flash</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">VfsFat</span><span class="o">.</span><span class="n">mkfs</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">VfsLfs2</span><span class="o">.</span><span class="n">mkfs</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="s1">'/flash'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="s1">'/data'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">'/flash'</span><span class="p">)</span>
</pre></div>
</div>
<p>This might be useful to make your Python files, configuration and other
rarely-modified content available over USB MSC, but allowing for frequently
changing application data to reside on littlefs with better resilience to power
failure, etc.</p>
<p>The partition at offset <code class="docutils literal notranslate"><span class="pre">0</span></code> will be mounted automatically (and the filesystem
type automatically detected), but you can add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">pyb</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">pyb</span><span class="o">.</span><span class="n">Flash</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="s1">'/data'</span><span class="p">)</span>
</pre></div>
</div>
<p>to <code class="docutils literal notranslate"><span class="pre">boot.py</span></code> to mount the data partition.</p>
</section>
<section id="hybrid-esp32">
<h3 id="hybrid-esp32"><a class="toc-backref" href="#id15">Hybrid (ESP32)</a><a class="headerlink" href="#hybrid-esp32" title="永久链接至标题">¶</a></h3>
<p>On ESP32, if you build custom firmware, you can modify <code class="docutils literal notranslate"><span class="pre">partitions.csv</span></code> to
define an arbitrary partition layout.</p>
<p>At boot, the partition named “vfs” will be mounted at <code class="docutils literal notranslate"><span class="pre">/</span></code> by default, but any
additional partitions can be mounted in your <code class="docutils literal notranslate"><span class="pre">boot.py</span></code> using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">esp32</span><span class="o">,</span> <span class="nn">os</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">esp32</span><span class="o">.</span><span class="n">Partition</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">esp32</span><span class="o">.</span><span class="n">Partition</span><span class="o">.</span><span class="n">TYPE_DATA</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'foo'</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">'/foo'</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>


          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="asm_thumb2_hints_tips.html" title="1. Hints and tips"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> <span class="section-number">1. </span>Hints and tips </span>
              </div>
            </a>
          
          
            <a href="pyboard.py.html" title="The pyboard.py tool"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> Next </span> The pyboard.py tool </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright - The MicroPython Documentation is Copyright © 2014-2022, Damien P. George, Paul Sokolovsky, and contributors.
              
          </div>
            Last updated on
              10 2月 2022.
            <br/>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>