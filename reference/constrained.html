
<!DOCTYPE html>

<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>MicroPython on microcontrollers &#8212; MicroPython 1.18 文档</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/material.css" />
    <link rel="stylesheet" href="../_static/customstyle.css" type="text/css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/translations.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="MicroPython 清单文件" href="manifest.html" />
    <link rel="prev" title="Maximising MicroPython speed" href="speed_python.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=blue data-md-color-accent=light-blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#reference/constrained" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../index.html" title="MicroPython 1.18 文档"
           class="md-header-nav__button md-logo">
          
            &nbsp;
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">MicroPython 1.18 文档</span>
          <span class="md-header-nav__topic"> MicroPython on microcontrollers </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
      
  
  <script src="../_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../"versions.json"",
        target_loc = "../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="../index.html" class="md-tabs__link">MicroPython 1.18 文档</a></li>
          <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">MicroPython 语言与实现</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../index.html" title="MicroPython 1.18 文档" class="md-nav__button md-logo">
      
        <img src="../_static/" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../index.html"
       title="MicroPython 1.18 文档">MicroPython 1.18 文档</a>
  </label>
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
    
      <a href="../library/index.html" class="md-nav__link">MicroPython 库</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="index.html" class="md-nav__link">MicroPython 语言与实现</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="glossary.html" class="md-nav__link">词汇表</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="repl.html" class="md-nav__link">MicroPython 交互式解释器模式 （又名 REPL）</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="mpremote.html" class="md-nav__link">MicroPython 远程控制: mpremote</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="mpyfiles.html" class="md-nav__link">MicroPython .mpy 文件</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="isr_rules.html" class="md-nav__link">Writing interrupt handlers</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="speed_python.html" class="md-nav__link">Maximising MicroPython speed</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    <label class="md-nav__link md-nav__link--active" for="__toc"> MicroPython on microcontrollers </label>
    
      <a href="#" class="md-nav__link md-nav__link--active">MicroPython on microcontrollers</a>
      
        
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#reference-constrained--page-root" class="md-nav__link">MicroPython on microcontrollers</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#flash-memory" class="md-nav__link">Flash memory</a>
        </li>
        <li class="md-nav__item"><a href="#ram" class="md-nav__link">RAM</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#compilation-phase" class="md-nav__link">Compilation phase</a>
        </li>
        <li class="md-nav__item"><a href="#execution-phase" class="md-nav__link">Execution phase</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#the-heap" class="md-nav__link">The heap</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#fragmentation" class="md-nav__link">Fragmentation</a>
        </li>
        <li class="md-nav__item"><a href="#reporting" class="md-nav__link">Reporting</a>
        </li>
        <li class="md-nav__item"><a href="#control-of-garbage-collection" class="md-nav__link">Control of garbage collection</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#string-operations" class="md-nav__link">String operations</a>
        </li>
        <li class="md-nav__item"><a href="#postscript" class="md-nav__link">Postscript</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#footnote-gc-collect-return-value" class="md-nav__link">Footnote: gc.collect() return value</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
  </ul>
</nav>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#flash-memory" class="md-nav__link">Flash memory</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#ram" class="md-nav__link">RAM</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#compilation-phase" class="md-nav__link">Compilation phase</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#execution-phase" class="md-nav__link">Execution phase</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#the-heap" class="md-nav__link">The heap</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#fragmentation" class="md-nav__link">Fragmentation</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#reporting" class="md-nav__link">Reporting</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#control-of-garbage-collection" class="md-nav__link">Control of garbage collection</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#string-operations" class="md-nav__link">String operations</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="#postscript" class="md-nav__link">Postscript</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="#footnote-gc-collect-return-value" class="md-nav__link">Footnote: gc.collect() return value</a>
      
    
    </li></ul>
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="manifest.html" class="md-nav__link">MicroPython 清单文件</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="packages.html" class="md-nav__link">分发包、包管理和部署应用程序</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="asm_thumb2_index.html" class="md-nav__link">Inline assembler for Thumb2 architectures</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="filesystem.html" class="md-nav__link">Working with filesystems</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="pyboard.py.html" class="md-nav__link">The pyboard.py tool</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../genrst/index.html" class="md-nav__link">MicroPython differences from CPython</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../develop/index.html" class="md-nav__link">MicroPython Internals</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../license.html" class="md-nav__link">MicroPython 开源协议信息</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../pyboard/quickref.html" class="md-nav__link">Quick reference for the pyboard</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../esp8266/quickref.html" class="md-nav__link">Quick reference for the ESP8266</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../esp32/quickref.html" class="md-nav__link">Quick reference for the ESP32</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../rp2/quickref.html" class="md-nav__link">Quick reference for the RP2</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../wipy/quickref.html" class="md-nav__link">Quick reference for the WiPy</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../unix/quickref.html" class="md-nav__link">Quick reference for the UNIX and Windows ports</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../zephyr/quickref.html" class="md-nav__link">Zephyr 适配的快速参考</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#reference-constrained--page-root" class="md-nav__link">MicroPython on microcontrollers</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#flash-memory" class="md-nav__link">Flash memory</a>
        </li>
        <li class="md-nav__item"><a href="#ram" class="md-nav__link">RAM</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#compilation-phase" class="md-nav__link">Compilation phase</a>
        </li>
        <li class="md-nav__item"><a href="#execution-phase" class="md-nav__link">Execution phase</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#the-heap" class="md-nav__link">The heap</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#fragmentation" class="md-nav__link">Fragmentation</a>
        </li>
        <li class="md-nav__item"><a href="#reporting" class="md-nav__link">Reporting</a>
        </li>
        <li class="md-nav__item"><a href="#control-of-garbage-collection" class="md-nav__link">Control of garbage collection</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#string-operations" class="md-nav__link">String operations</a>
        </li>
        <li class="md-nav__item"><a href="#postscript" class="md-nav__link">Postscript</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#footnote-gc-collect-return-value" class="md-nav__link">Footnote: gc.collect() return value</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <section id="micropython-on-microcontrollers">
<span id="constrained"></span><h1 id="reference-constrained--page-root">MicroPython on microcontrollers<a class="headerlink" href="#reference-constrained--page-root" title="Permalink to this heading">¶</a></h1>
<p>MicroPython is designed to be capable of running on microcontrollers. These
have hardware limitations which may be unfamiliar to programmers more familiar
with conventional computers. In particular the amount of RAM and nonvolatile
“disk” (flash memory) storage is limited. This tutorial offers ways to make
the most of the limited resources. Because MicroPython runs on controllers
based on a variety of architectures, the methods presented are generic: in some
cases it will be necessary to obtain detailed information from platform specific
documentation.</p>
<section id="flash-memory">
<h2 id="flash-memory">Flash memory<a class="headerlink" href="#flash-memory" title="Permalink to this heading">¶</a></h2>
<p>On the Pyboard the simple way to address the limited capacity is to fit a micro
SD card. In some cases this is impractical, either because the device does not
have an SD card slot or for reasons of cost or power consumption; hence the
on-chip flash must be used. The firmware including the MicroPython subsystem is
stored in the onboard flash. The remaining capacity is available for use. For
reasons connected with the physical architecture of the flash memory part of
this capacity may be inaccessible as a filesystem. In such cases this space may
be employed by incorporating user modules into a firmware build which is then
flashed to the device.</p>
<p>There are two ways to achieve this: frozen modules and frozen bytecode. Frozen
modules store the Python source with the firmware. Frozen bytecode uses the
cross compiler to convert the source to bytecode which is then stored with the
firmware. In either case the module may be accessed with an import statement:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mymodule</span>
</pre></div>
</div>
<p>The procedure for producing frozen modules and bytecode is platform dependent;
instructions for building the firmware can be found in the README files in the
relevant part of the source tree.</p>
<p>In general terms the steps are as follows:</p>
<ul class="simple">
<li><p>Clone the MicroPython <a class="reference external" href="https://github.com/micropython/micropython">repository</a>.</p></li>
<li><p>Acquire the (platform specific) toolchain to build the firmware.</p></li>
<li><p>Build the cross compiler.</p></li>
<li><p>Place the modules to be frozen in a specified directory (dependent on whether
the module is to be frozen as source or as bytecode).</p></li>
<li><p>Build the firmware. A specific command may be required to build frozen
code of either type - see the platform documentation.</p></li>
<li><p>Flash the firmware to the device.</p></li>
</ul>
</section>
<section id="ram">
<h2 id="ram">RAM<a class="headerlink" href="#ram" title="Permalink to this heading">¶</a></h2>
<p>When reducing RAM usage there are two phases to consider: compilation and
execution. In addition to memory consumption, there is also an issue known as
heap fragmentation. In general terms it is best to minimise the repeated
creation and destruction of objects. The reason for this is covered in the
section covering the <a class="reference internal" href="#heap">heap</a>.</p>
<section id="compilation-phase">
<h3 id="compilation-phase">Compilation phase<a class="headerlink" href="#compilation-phase" title="Permalink to this heading">¶</a></h3>
<p>When a module is imported, MicroPython compiles the code to bytecode which is
then executed by the MicroPython virtual machine (VM). The bytecode is stored
in RAM. The compiler itself requires RAM, but this becomes available for use
when the compilation has completed.</p>
<p>If a number of modules have already been imported the situation can arise where
there is insufficient RAM to run the compiler. In this case the import
statement will produce a memory exception.</p>
<p>If a module instantiates global objects on import it will consume RAM at the
time of import, which is then unavailable for the compiler to use on subsequent
imports. In general it is best to avoid code which runs on import; a better
approach is to have initialisation code which is run by the application after
all modules have been imported. This maximises the RAM available to the
compiler.</p>
<p>If RAM is still insufficient to compile all modules one solution is to
precompile modules. MicroPython has a cross compiler capable of compiling Python
modules to bytecode (see the README in the mpy-cross directory). The resulting
bytecode file has a .mpy extension; it may be copied to the filesystem and
imported in the usual way. Alternatively some or all modules may be implemented
as frozen bytecode: on most platforms this saves even more RAM as the bytecode
is run directly from flash rather than being stored in RAM.</p>
</section>
<section id="execution-phase">
<h3 id="execution-phase">Execution phase<a class="headerlink" href="#execution-phase" title="Permalink to this heading">¶</a></h3>
<p>There are a number of coding techniques for reducing RAM usage.</p>
<p><strong>Constants</strong></p>
<p>MicroPython provides a <code class="docutils literal notranslate"><span class="pre">const</span></code> keyword which may be used as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">micropython</span> <span class="k">import</span> <span class="n">const</span>
<span class="n">ROWS</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mi">33</span><span class="p">)</span>
<span class="n">_COLS</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">ROWS</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">_COLS</span>
</pre></div>
</div>
<p>In both instances where the constant is assigned to a variable the compiler
will avoid coding a lookup to the name of the constant by substituting its
literal value. This saves bytecode and hence RAM. However the <code class="docutils literal notranslate"><span class="pre">ROWS</span></code> value
will occupy at least two machine words, one each for the key and value in the
globals dictionary. The presence in the dictionary is necessary because another
module might import or use it. This RAM can be saved by prepending the name
with an underscore as in <code class="docutils literal notranslate"><span class="pre">_COLS</span></code>: this symbol is not visible outside the
module so will not occupy RAM.</p>
<p>The argument to <code class="docutils literal notranslate"><span class="pre">const()</span></code> may be anything which, at compile time, evaluates
to an integer e.g. <code class="docutils literal notranslate"><span class="pre">0x100</span></code> or <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">&lt;&lt;</span> <span class="pre">8</span></code>. It can even include other const
symbols that have already been defined, e.g. <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">&lt;&lt;</span> <span class="pre">BIT</span></code>.</p>
<p><strong>Constant data structures</strong></p>
<p>Where there is a substantial volume of constant data and the platform supports
execution from Flash, RAM may be saved as follows. The data should be located in
Python modules and frozen as bytecode. The data must be defined as <a class="reference internal" href="../library/builtins.html#bytes" title="bytes"><code class="xref any py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a>
objects. The compiler ‘knows’ that <a class="reference internal" href="../library/builtins.html#bytes" title="bytes"><code class="xref any py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a> objects are immutable and ensures
that the objects remain in flash memory rather than being copied to RAM. The
<a class="reference internal" href="../library/struct.html#module-struct" title="struct: pack and unpack primitive data types"><code class="xref any py py-mod docutils literal notranslate"><span class="pre">struct</span></code></a> module can assist in converting between <a class="reference internal" href="../library/builtins.html#bytes" title="bytes"><code class="xref any py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a> types and other
Python built-in types.</p>
<p>When considering the implications of frozen bytecode, note that in Python
strings, floats, bytes, integers and complex numbers are immutable. Accordingly
these will be frozen into flash. Thus, in the line</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mystring</span> <span class="o">=</span> <span class="s2">"The quick brown fox"</span>
</pre></div>
</div>
<p>the actual string “The quick brown fox” will reside in flash. At runtime a
reference to the string is assigned to the <em>variable</em> <code class="docutils literal notranslate"><span class="pre">mystring</span></code>. The reference
occupies a single machine word. In principle a long integer could be used to
store constant data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bar</span> <span class="o">=</span> <span class="mh">0xDEADBEEF0000DEADBEEF</span>
</pre></div>
</div>
<p>As in the string example, at runtime a reference to the arbitrarily large
integer is assigned to the variable <code class="docutils literal notranslate"><span class="pre">bar</span></code>. That reference occupies a
single machine word.</p>
<p>It might be expected that tuples of integers could be employed for the purpose
of storing constant data with minimal RAM use. With the current compiler this
is ineffective (the code works, but RAM is not saved).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">foo</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)</span>
</pre></div>
</div>
<p>At runtime the tuple will be located in RAM. This may be subject to future
improvement.</p>
<p><strong>Needless object creation</strong></p>
<p>There are a number of situations where objects may unwittingly be created and
destroyed. This can reduce the usability of RAM through fragmentation. The
following sections discuss instances of this.</p>
<p><strong>String concatenation</strong></p>
<p>Consider the following code fragments which aim to produce constant strings:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="o">=</span> <span class="s2">"foo"</span> <span class="o">+</span> <span class="s2">"bar"</span>
<span class="n">var1</span> <span class="o">=</span> <span class="s2">"foo"</span> <span class="s2">"bar"</span>
<span class="n">var2</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">foo</span><span class="se">\</span>
<span class="s2">bar"""</span>
</pre></div>
</div>
<p>Each produces the same outcome, however the first needlessly creates two string
objects at runtime, allocates more RAM for concatenation before producing the
third. The others perform the concatenation at compile time which is more
efficient, reducing fragmentation.</p>
<p>Where strings must be dynamically created before being fed to a stream such as
a file it will save RAM if this is done in a piecemeal fashion. Rather than
creating a large string object, create a substring and feed it to the stream
before dealing with the next.</p>
<p>The best way to create dynamic strings is by means of the string <code class="docutils literal notranslate"><span class="pre">format()</span></code>
method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="o">=</span> <span class="s2">"Temperature </span><span class="si">{:5.2f}</span><span class="s2"> Pressure </span><span class="si">{:06d}</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">press</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Buffers</strong></p>
<p>When accessing devices such as instances of UART, I2C and SPI interfaces, using
pre-allocated buffers avoids the creation of needless objects. Consider these
two loops:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">spi</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="c1"># process data</span>

<span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">spi</span><span class="o">.</span><span class="n">readinto</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
    <span class="c1"># process data in buf</span>
</pre></div>
</div>
<p>The first creates a buffer on each pass whereas the second re-uses a pre-allocated
buffer; this is both faster and more efficient in terms of memory fragmentation.</p>
<p><strong>Bytes are smaller than ints</strong></p>
<p>On most platforms an integer consumes four bytes. Consider the two calls to the
function <code class="docutils literal notranslate"><span class="pre">foo()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">bar</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bar</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">foo</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">))</span>
<span class="n">foo</span><span class="p">(</span><span class="sa">b</span><span class="s1">'</span><span class="se">\1\2\xff</span><span class="s1">'</span><span class="p">)</span>
</pre></div>
</div>
<p>In the first call a tuple of integers is created in RAM. The second efficiently
creates a <a class="reference internal" href="../library/builtins.html#bytes" title="bytes"><code class="xref any py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a> object consuming the minimum amount of RAM. If the module
were frozen as bytecode, the <a class="reference internal" href="../library/builtins.html#bytes" title="bytes"><code class="xref any py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a> object would reside in flash.</p>
<p><strong>Strings Versus Bytes</strong></p>
<p>Python3 introduced Unicode support. This introduced a distinction between a
string and an array of bytes. MicroPython ensures that Unicode strings take no
additional space so long as all characters in the string are ASCII (i.e. have
a value &lt; 126). If values in the full 8-bit range are required <a class="reference internal" href="../library/builtins.html#bytes" title="bytes"><code class="xref any py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a> and
<a class="reference internal" href="../library/builtins.html#bytearray" title="bytearray"><code class="xref any py py-class docutils literal notranslate"><span class="pre">bytearray</span></code></a> objects can be used to ensure that no additional space will be
required. Note that most string methods (e.g. <a class="reference external" href="https://docs.python.org/3.5/library/stdtypes.html#str.strip" title="(在 Python v3.5)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">str.strip()</span></code></a>) apply also to <a class="reference internal" href="../library/builtins.html#bytes" title="bytes"><code class="xref any py py-class docutils literal notranslate"><span class="pre">bytes</span></code></a>
instances so the process of eliminating Unicode can be painless.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="s1">'the quick brown fox'</span>   <span class="c1"># A string instance</span>
<span class="n">b</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'the quick brown fox'</span>  <span class="c1"># A bytes instance</span>
</pre></div>
</div>
<p>Where it is necessary to convert between strings and bytes the <a class="reference external" href="https://docs.python.org/3.5/library/stdtypes.html#str.encode" title="(在 Python v3.5)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">str.encode()</span></code></a>
and the <a class="reference external" href="https://docs.python.org/3.5/library/stdtypes.html#bytes.decode" title="(在 Python v3.5)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">bytes.decode()</span></code></a> methods can be used. Note that both strings and bytes
are immutable. Any operation which takes as input such an object and produces
another implies at least one RAM allocation to produce the result. In the
second line below a new bytes object is allocated. This would also occur if <code class="docutils literal notranslate"><span class="pre">foo</span></code>
were a string.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">foo</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">'   empty whitespace'</span>
<span class="n">foo</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>Runtime compiler execution</strong></p>
<p>The Python funcitons <a class="reference internal" href="../library/builtins.html#eval" title="eval"><code class="xref any py py-func docutils literal notranslate"><span class="pre">eval</span></code></a> and <a class="reference internal" href="../library/builtins.html#exec" title="exec"><code class="xref any py py-func docutils literal notranslate"><span class="pre">exec</span></code></a> invoke the compiler at runtime, which
requires significant amounts of RAM. Note that the <code class="docutils literal notranslate"><span class="pre">pickle</span></code> library from
<a class="reference internal" href="glossary.html#term-micropython-lib"><code class="xref any std std-term docutils literal notranslate"><span class="pre">micropython-lib</span></code></a> employs <a class="reference internal" href="../library/builtins.html#exec" title="exec"><code class="xref any py py-func docutils literal notranslate"><span class="pre">exec</span></code></a>. It may be more RAM efficient to use the
<a class="reference internal" href="../library/json.html#module-json" title="json: JSON encoding and decoding"><code class="xref any py py-mod docutils literal notranslate"><span class="pre">json</span></code></a> library for object serialisation.</p>
<p><strong>Storing strings in flash</strong></p>
<p>Python strings are immutable hence have the potential to be stored in read only
memory. The compiler can place in flash strings defined in Python code. As with
frozen modules it is necessary to have a copy of the source tree on the PC and
the toolchain to build the firmware. The procedure will work even if the
modules have not been fully debugged, so long as they can be imported and run.</p>
<p>After importing the modules, execute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">micropython</span><span class="o">.</span><span class="n">qstr_info</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Then copy and paste all the Q(xxx) lines into a text editor. Check for and
remove lines which are obviously invalid. Open the file qstrdefsport.h which
will be found in ports/stm32 (or the equivalent directory for the architecture in
use). Copy and paste the corrected lines at the end of the file. Save the file,
rebuild and flash the firmware. The outcome can be checked by importing the
modules and again issuing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">micropython</span><span class="o">.</span><span class="n">qstr_info</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>The Q(xxx) lines should be gone.</p>
</section>
</section>
<section id="the-heap">
<span id="heap"></span><h2 id="the-heap">The heap<a class="headerlink" href="#the-heap" title="Permalink to this heading">¶</a></h2>
<p>When a running program instantiates an object the necessary RAM is allocated
from a fixed size pool known as the heap. When the object goes out of scope (in
other words becomes inaccessible to code) the redundant object is known as
“garbage”. A process known as “garbage collection” (GC) reclaims that memory,
returning it to the free heap. This process runs automatically, however it can
be invoked directly by issuing <a class="reference internal" href="../library/gc.html#gc.collect" title="gc.collect"><code class="xref any py py-func docutils literal notranslate"><span class="pre">gc.collect()</span></code></a>.</p>
<p>The discourse on this is somewhat involved. For a ‘quick fix’ issue the
following periodically:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="n">gc</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">()</span> <span class="o">//</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">gc</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">())</span>
</pre></div>
</div>
<section id="fragmentation">
<h3 id="fragmentation">Fragmentation<a class="headerlink" href="#fragmentation" title="Permalink to this heading">¶</a></h3>
<p>Say a program creates an object <code class="docutils literal notranslate"><span class="pre">foo</span></code>, then an object <code class="docutils literal notranslate"><span class="pre">bar</span></code>. Subsequently
<code class="docutils literal notranslate"><span class="pre">foo</span></code> goes out of scope but <code class="docutils literal notranslate"><span class="pre">bar</span></code> remains. The RAM used by <code class="docutils literal notranslate"><span class="pre">foo</span></code> will be
reclaimed by GC. However if <code class="docutils literal notranslate"><span class="pre">bar</span></code> was allocated to a higher address, the
RAM reclaimed from <code class="docutils literal notranslate"><span class="pre">foo</span></code> will only be of use for objects no bigger than
<code class="docutils literal notranslate"><span class="pre">foo</span></code>. In a complex or long running program the heap can become fragmented:
despite there being a substantial amount of RAM available, there is insufficient
contiguous space to allocate a particular object, and the program fails with a
memory error.</p>
<p>The techniques outlined above aim to minimise this. Where large permanent buffers
or other objects are required it is best to instantiate these early in the
process of program execution before fragmentation can occur. Further improvements
may be made by monitoring the state of the heap and by controlling GC; these are
outlined below.</p>
</section>
<section id="reporting">
<h3 id="reporting">Reporting<a class="headerlink" href="#reporting" title="Permalink to this heading">¶</a></h3>
<p>A number of library functions are available to report on memory allocation and
to control GC. These are to be found in the <a class="reference internal" href="../library/gc.html#module-gc" title="gc: control the garbage collector"><code class="xref any py py-mod docutils literal notranslate"><span class="pre">gc</span></code></a> and <a class="reference internal" href="../library/micropython.html#module-micropython" title="micropython: access and control MicroPython internals"><code class="xref any py py-mod docutils literal notranslate"><span class="pre">micropython</span></code></a> modules.
The following example may be pasted at the REPL (<code class="docutils literal notranslate"><span class="pre">ctrl</span> <span class="pre">e</span></code> to enter paste mode,
<code class="docutils literal notranslate"><span class="pre">ctrl</span> <span class="pre">d</span></code> to run it).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">micropython</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="n">micropython</span><span class="o">.</span><span class="n">mem_info</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'-----------------------------'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Initial free: </span><span class="si">{}</span><span class="s1"> allocated: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">(),</span> <span class="n">gc</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">()))</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Func definition: </span><span class="si">{}</span><span class="s1"> allocated: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">(),</span> <span class="n">gc</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">()))</span>
<span class="n">func</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Func run free: </span><span class="si">{}</span><span class="s1"> allocated: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">(),</span> <span class="n">gc</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">()))</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'Garbage collect free: </span><span class="si">{}</span><span class="s1"> allocated: </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">(),</span> <span class="n">gc</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'-----------------------------'</span><span class="p">)</span>
<span class="n">micropython</span><span class="o">.</span><span class="n">mem_info</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Methods employed above:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../library/gc.html#gc.collect" title="gc.collect"><code class="xref any py py-func docutils literal notranslate"><span class="pre">gc.collect()</span></code></a> Force a garbage collection. See footnote.</p></li>
<li><p><a class="reference internal" href="../library/micropython.html#micropython.mem_info" title="micropython.mem_info"><code class="xref any py py-func docutils literal notranslate"><span class="pre">micropython.mem_info()</span></code></a> Print a summary of RAM utilisation.</p></li>
<li><p><a class="reference internal" href="../library/gc.html#gc.mem_free" title="gc.mem_free"><code class="xref any py py-func docutils literal notranslate"><span class="pre">gc.mem_free()</span></code></a> Return the free heap size in bytes.</p></li>
<li><p><a class="reference internal" href="../library/gc.html#gc.mem_alloc" title="gc.mem_alloc"><code class="xref any py py-func docutils literal notranslate"><span class="pre">gc.mem_alloc()</span></code></a> Return the number of bytes currently allocated.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">micropython.mem_info(1)</span></code> Print a table of heap utilisation (detailed below).</p></li>
</ul>
<p>The numbers produced are dependent on the platform, but it can be seen that
declaring the function uses a small amount of RAM in the form of bytecode
emitted by the compiler (the RAM used by the compiler has been reclaimed).
Running the function uses over 10KiB, but on return <code class="docutils literal notranslate"><span class="pre">a</span></code> is garbage because it
is out of scope and cannot be referenced. The final <a class="reference internal" href="../library/gc.html#gc.collect" title="gc.collect"><code class="xref any py py-func docutils literal notranslate"><span class="pre">gc.collect()</span></code></a> recovers
that memory.</p>
<p>The final output produced by <code class="docutils literal notranslate"><span class="pre">micropython.mem_info(1)</span></code> will vary in detail but
may be interpreted as follows:</p>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>Symbol</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>.</p></td>
<td><p>free block</p></td>
</tr>
<tr class="row-odd"><td><p>h</p></td>
<td><p>head block</p></td>
</tr>
<tr class="row-even"><td><p>=</p></td>
<td><p>tail block</p></td>
</tr>
<tr class="row-odd"><td><p>m</p></td>
<td><p>marked head block</p></td>
</tr>
<tr class="row-even"><td><p>T</p></td>
<td><p>tuple</p></td>
</tr>
<tr class="row-odd"><td><p>L</p></td>
<td><p>list</p></td>
</tr>
<tr class="row-even"><td><p>D</p></td>
<td><p>dict</p></td>
</tr>
<tr class="row-odd"><td><p>F</p></td>
<td><p>float</p></td>
</tr>
<tr class="row-even"><td><p>B</p></td>
<td><p>byte code</p></td>
</tr>
<tr class="row-odd"><td><p>M</p></td>
<td><p>module</p></td>
</tr>
</tbody>
</table>
<p>Each letter represents a single block of memory, a block being 16 bytes. So each
line of the heap dump represents 0x400 bytes or 1KiB of RAM.</p>
</section>
<section id="control-of-garbage-collection">
<h3 id="control-of-garbage-collection">Control of garbage collection<a class="headerlink" href="#control-of-garbage-collection" title="Permalink to this heading">¶</a></h3>
<p>A GC can be demanded at any time by issuing <a class="reference internal" href="../library/gc.html#gc.collect" title="gc.collect"><code class="xref any py py-func docutils literal notranslate"><span class="pre">gc.collect()</span></code></a>. It is advantageous
to do this at intervals, firstly to pre-empt fragmentation and secondly for
performance. A GC can take several milliseconds but is quicker when there is
little work to do (about 1ms on the Pyboard). An explicit call can minimise that
delay while ensuring it occurs at points in the program when it is acceptable.</p>
<p>Automatic GC is provoked under the following circumstances. When an attempt at
allocation fails, a GC is performed and the allocation re-tried. Only if this
fails is an exception raised. Secondly an automatic GC will be triggered if the
amount of free RAM falls below a threshold. This threshold can be adapted as
execution progresses:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="n">gc</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">mem_free</span><span class="p">()</span> <span class="o">//</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">gc</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">())</span>
</pre></div>
</div>
<p>This will provoke a GC when more than 25% of the currently free heap becomes
occupied.</p>
<p>In general modules should instantiate data objects at runtime using constructors
or other initialisation functions. The reason is that if this occurs on
initialisation the compiler may be starved of RAM when subsequent modules are
imported. If modules do instantiate data on import then <a class="reference internal" href="../library/gc.html#gc.collect" title="gc.collect"><code class="xref any py py-func docutils literal notranslate"><span class="pre">gc.collect()</span></code></a> issued
after the import will ameliorate the problem.</p>
</section>
</section>
<section id="string-operations">
<h2 id="string-operations">String operations<a class="headerlink" href="#string-operations" title="Permalink to this heading">¶</a></h2>
<p>MicroPython handles strings in an efficient manner and understanding this can
help in designing applications to run on microcontrollers. When a module
is compiled, strings which occur multiple times are stored once only, a process
known as string interning. In MicroPython an interned string is known as a <code class="docutils literal notranslate"><span class="pre">qstr</span></code>.
In a module imported normally that single instance will be located in RAM, but
as described above, in modules frozen as bytecode it will be located in flash.</p>
<p>String comparisons are also performed efficiently using hashing rather than
character by character. The penalty for using strings rather than integers may
hence be small both in terms of performance and RAM usage - a fact which may
come as a surprise to C programmers.</p>
</section>
<section id="postscript">
<h2 id="postscript">Postscript<a class="headerlink" href="#postscript" title="Permalink to this heading">¶</a></h2>
<p>MicroPython passes, returns and (by default) copies objects by reference. A
reference occupies a single machine word so these processes are efficient in
RAM usage and speed.</p>
<p>Where variables are required whose size is neither a byte nor a machine word
there are standard libraries which can assist in storing these efficiently and
in performing conversions. See the <a class="reference internal" href="../library/array.html#module-array" title="array: efficient arrays of numeric data"><code class="xref any py py-mod docutils literal notranslate"><span class="pre">array</span></code></a>, <a class="reference internal" href="../library/struct.html#module-struct" title="struct: pack and unpack primitive data types"><code class="xref any py py-mod docutils literal notranslate"><span class="pre">struct</span></code></a> and <a class="reference internal" href="../library/uctypes.html#module-uctypes" title="uctypes: access binary data in a structured way"><code class="xref any py py-mod docutils literal notranslate"><span class="pre">uctypes</span></code></a>
modules.</p>
<section id="footnote-gc-collect-return-value">
<h3 id="footnote-gc-collect-return-value">Footnote: gc.collect() return value<a class="headerlink" href="#footnote-gc-collect-return-value" title="Permalink to this heading">¶</a></h3>
<p>On Unix and Windows platforms the <a class="reference internal" href="../library/gc.html#gc.collect" title="gc.collect"><code class="xref any py py-func docutils literal notranslate"><span class="pre">gc.collect()</span></code></a> method returns an integer
which signifies the number of distinct memory regions that were reclaimed in the
collection (more precisely, the number of heads that were turned into frees). For
efficiency reasons bare metal ports do not return this value.</p>
</section>
</section>
</section>


          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="speed_python.html" title="Maximising MicroPython speed"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> Maximising MicroPython speed </span>
              </div>
            </a>
          
          
            <a href="manifest.html" title="MicroPython 清单文件"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> Next </span> MicroPython 清单文件 </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright - The MicroPython Documentation is Copyright © 2014-2022, Damien P. George, Paul Sokolovsky, and contributors.
              
          </div>
            Last updated on
              21 6月 2022.
            <br/>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 5.0.2.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>